pool:
  vmImage: 'Ubuntu 16.04'
  
variables:
  buildConfiguration: 'Release'

steps:
- script: dotnet build --configuration $(buildConfiguration)
  displayName: 'Build'
- script: |
    mkdir $(Build.SourcesDirectory)/results
    dotnet test tests/Soulseek.NET.Tests.Unit --configuration $(buildConfiguration) --logger trx -p:CollectCoverage=true -p:CoverletOutputFormat=cobertura
    dotnet test tests/Soulseek.NET.Tests.Integration --configuration $(buildConfiguration) --logger trx -p:CollectCoverage=true -p:CoverletOutputFormat=cobertura -p:MergeWtih=$(Build.SourcesDirectory)/tests/Soulseek.NET.Tests.Unit/coverage.cobertura.xml
    dotnet tool install dotnet-reportgenerator-globaltool --tool-path . --version 4.0.0-rc4
    ./reportgenerator "-reports:$(Build.SourcesDirectory)/tests/Soulseek.NET.Tests.Unit/coverage.cobertura.xml" "-targetdir:results" "-reporttypes:HTMLInline;HTMLChart"
  displayName: 'Test and Cover'
- task: PublishTestResults@2
  inputs:
    testRunner: VSTest
    testResultsFiles: '**/*.trx'
- task: PublishCodeCoverageResults@1
  inputs:
    summaryFileLocation: $(Build.SourcesDirectory)/results/coverage.cobertura.xml
    reportDirectory: $(Build.SourcesDirectory)/results
    codecoverageTool: cobertura